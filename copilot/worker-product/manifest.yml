name: worker-product
type: Worker Service

image:
  build:
    platforms: linux/amd64 # アーキテクチャを指定
    dockerfile: ./copilot/worker-product/Dockerfile
    cache_from:
      - 502078855105.dkr.ecr.ap-northeast-1.amazonaws.com/pos/worker-product:latest
    context: .
    target: ${COPILOT_ENVIRONMENT_NAME}

cpu: 256 # DBサーバーの負担を減らすためにあえて低性能
memory: 512
platform: linux/x86_64
count: 0
exec: true

# stagingとproductionだけで動かす
environments:
  staging:
    count: 1
    subscribe:
      topics:
        - name: product
          service: pos-web-app
      queue:
        fifo: true # 順番も保証させる
        retention: 24h
        timeout: 60s # 60秒でタイムアウト
        dead_letter:
          tries: 3

  production:
    count: # productionではスケーリング
      range:
        min: 2
        max: 10
        spot_from: 3
      queue_delay:
        acceptable_latency: 30m # 30分以内で全て処理完了させたい
        msg_processing_time: 4000ms # 1タスク4秒で終わる計算
    subscribe:
      topics:
        - name: product
          service: pos-web-app
      queue:
        fifo: true # 順番も保証させる
        retention: 100h
        timeout: 60s # 60秒でタイムアウト
        dead_letter:
          tries: 3

    # 以下、ダミー

  customer:
    image:
      location: 502078855105.dkr.ecr.ap-northeast-1.amazonaws.com/pos/pos-web-app:e3a39596-777b-4d5e-b401-dce099d7cd63-staging

  develop:
    image:
      location: 502078855105.dkr.ecr.ap-northeast-1.amazonaws.com/pos/pos-web-app:e3a39596-777b-4d5e-b401-dce099d7cd63-staging

secrets: # 環境変数（secret managerに保存済み）
  NODE_OPTIONS: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NODE_OPTIONS
  NEXT_PUBLIC_ORIGIN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_ORIGIN
  NEXT_PUBLIC_SERVICE_ORIGIN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_SERVICE_ORIGIN
  RUN_MODE: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/RUN_MODE
  NEXTAUTH_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXTAUTH_URL
  NEXTAUTH_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXTAUTH_SECRET
  SQUARE_WEBHOOK_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_WEBHOOK_URL
  SQUARE_OAUTH_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_URL
  RUN_SQUARE: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/RUN_SQUARE
  SQUARE_WEBHOOK_SIGNATURE_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_WEBHOOK_SIGNATURE_KEY
  SQUARE_OAUTH_REDIRECT_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_REDIRECT_URL
  SQUARE_OAUTH_APPLICATION_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_APPLICATION_ID
  SQUARE_OAUTH_APPLICATION_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_APPLICATION_SECRET
  SQUARE_RUN_MODE: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_RUN_MODE
  SQUARE_REFID_PREFIX: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_REFID_PREFIX
  DATABASE_SERVER_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/DATABASE_SERVER_URL_FOR_WORKER
  NEXT_PUBLIC_DATABASE_KIND: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_DATABASE_KIND
  READREP_DATABASE_SERVER_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/READREP_DATABASE_SERVER_URL_FOR_WORKER

  ELASTI_CACHE_ENDPOINT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/ELASTI_CACHE_ENDPOINT
  SYSTEM_EMAIL_ADDRESS: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SYSTEM_EMAIL_ADDRESS
  SERVICE_EMAIL_ADDRESS: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SERVICE_EMAIL_ADDRESS
  PYTHON_API_ENDPOINT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PYTHON_API_ENDPOINT
  NEXT_PUBLIC_EC_ORIGIN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_EC_ORIGIN
  MYCA_ADMIN_TOKEN: /copilot/app-main-api/production/secrets/ADMIN_PASSWORD
  MASTER_PASSWORD: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/MASTER_PASSWORD
  GMO_OPENAPI_BASE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_BASE_URL
  GMO_OPENAPI_USERNAME: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_USERNAME
  GMO_OPENAPI_PASSWORD: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_PASSWORD
  GMO_OPENAPI_USERNAME_CONTRACT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_USERNAME_CONTRACT
  GMO_OPENAPI_PASSWORD_CONTRACT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_PASSWORD_CONTRACT
  ITEM_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/ITEM_WORKER_QUEUE_URL
  ITEM_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/ITEM_SNS_TOPIC_ARN
  SLACK_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SLACK_SNS_TOPIC_ARN
  SLACK_INFRA_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SLACK_INFRA_SNS_TOPIC_ARN
  TRANSACTION_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/TRANSACTION_WORKER_QUEUE_URL
  TRANSACTION_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/TRANSACTION_SNS_TOPIC_ARN
  EVENT_BRIDGE_SQS_ROLE_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/EVENT_BRIDGE_SQS_ROLE_ARN

  BOT_TOKEN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/BOT_TOKEN
  EC_ORDER_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/EC_ORDER_WORKER_QUEUE_URL
  EXTERNAL_EC_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/EXTERNAL_EC_WORKER_QUEUE_URL
  GMO_WEBHOOK_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_WEBHOOK_URL
  PRODUCT_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRODUCT_WORKER_QUEUE_URL
  SCHEDULED_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SCHEDULED_WORKER_QUEUE_URL
  NOTIFICATION_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NOTIFICATION_WORKER_QUEUE_URL
  AMAZON_ACCESS_KEY_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/AMAZON_ACCESS_KEY_ID
  AMAZON_SECRET_ACCESS_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/AMAZON_SECRET_ACCESS_KEY
  AMAZON_S3_BUCKET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/AMAZON_S3_BUCKET
  BARCODE_PRIVATE_KEY: /copilot/app-main-api/production/secrets/BARCODE_PRIVATE_KEY
  BARCODE_IV: /copilot/app-main-api/production/secrets/BARCODE_IV
  PRIVATE_STATIC_BUCKET_PRIVATE_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_PRIVATE_KEY
  PRIVATE_STATIC_BUCKET_KEY_PAIR_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_KEY_PAIR_ID
  PRIVATE_STATIC_BUCKET_CLOUDFRONT_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_CLOUDFRONT_URL
  PRIVATE_STATIC_BUCKET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET
  PRIVATE_STATIC_BUCKET_HOST: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_HOST
  SHOPIFY_APP_CLIENT_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SHOPIFY_APP_CLIENT_ID
  SHOPIFY_APP_CLIENT_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SHOPIFY_APP_CLIENT_SECRET
  SHOPIFY_OAUTH_CALLBACK_URI: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SHOPIFY_OAUTH_CALLBACK_URI
  MYCA_APP_JWT_PUBLIC_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/MYCA_APP_JWT_PUBLIC_KEY
