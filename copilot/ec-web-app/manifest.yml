name: ec-web-app
type: Load Balanced Web Service

http:
  path: '/'
  target_container: 'nginx'
  healthcheck:
    path: '/api/system/health-check'
    success_codes: '200'
    healthy_threshold: 3
    unhealthy_threshold: 2
    interval: 30s
    timeout: 20s
    grace_period: 60s

image:
  location: will injected by pipeline
  # build:
  #   platforms: linux/amd64 # アーキテクチャを指定
  #   dockerfile: ./copilot/pos-web-app/Dockerfile #一旦同じイメージを使う感じで
  #   context: .
  #   target: ${COPILOT_ENVIRONMENT_NAME}
  #   cache_from:
  #     - 502078855105.dkr.ecr.ap-northeast-1.amazonaws.com/pos/pos-web-app:latest
  port: 3000
  depends_on:
    nginx: start
    # python: start

deployment:
  rolling: default

cpu: 1024
memory: 2048
platform: linux/x86_64
count: # 本番ではスケーリングさせる 1〜5にしておく
  range: 1-5
  cooldown:
    in: 60s
    out: 30s
  cpu_percentage: 50
exec: true
network:
  connect: true

# storage:
#   volumes:
#     uploaded: #アップロードされたファイル
#       path: /usr/app/packages/web-app/uploaded
#       read_only: false #書き込みが必要
#       efs: false #永続化する必要がないし、タスク間でも共有しない

sidecars: #sidecarsのイメージはあまり変わらないものが多いため、一通り完成したらECRのARN直指定でいきたい
  nginx:
    port: 80
    image:
      502078855105.dkr.ecr.ap-northeast-1.amazonaws.com/pos/pos-web-app:nginx-latest
      # build:
      #   platforms: linux/amd64 # アーキテクチャを指定
      #   dockerfile: ./copilot/pos-web-app/sidecars/nginx/Dockerfile
      #   target: production
      #   context: .
      #   args:
      #     BUILD_ENV: production
  # python: # ECの方ではPythonサーバーを建てる必要がない
  #   port: 3050
  #   image: 502078855105.dkr.ecr.ap-northeast-1.amazonaws.com/pos/pos-web-app:python-latest
  #   # image:
  #   #   build:
  #   #     platforms: linux/amd64 # アーキテクチャを指定
  #   #     dockerfile: ./copilot/pos-web-app/sidecars/python/Dockerfile
  #   #     context: .
  #   #     args:
  #   #       BUILD_ENV: production

environments:
  staging:
    cpu: 512 # ステージングでは絞る
    memory: 1024 # メモリは一旦絞らない
    count: 1 # ステージングではオートスケーリングをオフにする
    deployment:
      rolling: default
    http:
      path: '/'
      healthcheck:
        path: '/api/system/health-check'
        success_codes: '200'
        interval: 120s # 120秒間隔でヘルスチェック

  develop:
    cpu: 512 # ステージングでは絞る
    memory: 1024 # メモリは一旦絞らない
    count: 1 # ステージングではオートスケーリングをオフにする
    deployment:
      rolling: default
    http:
      path: '/'
      healthcheck:
        path: '/api/system/health-check'
        success_codes: '200'
        interval: 120s # 120秒間隔でヘルスチェック

  production:
    cpu: 512 # ステージングでは絞る
    memory: 1024 # メモリは一旦絞らない
    count: 1 # ステージングではオートスケーリングをオフにする
    deployment:
      rolling: default
    http:
      path: '/'
      healthcheck:
        path: '/api/system/health-check'
        success_codes: '200'
        interval: 120s # 120秒間隔でヘルスチェック

  # production:
  #   publish:
  #     topics:
  #       - name: item
  #         fifo: true # 順番も保証させる
  #       - name: transaction
  #         fifo: true # 順番も保証させる
  #       - name: ec-order
  #         fifo: true # 順番も保証させる
  #       - name: outbox
  #         fifo: true # 順番も保証させる（イベントの順番を正確に保持させる）

  customer:
    cpu: 1024
    memory: 3072
    count: # 本番ではスケーリングさせる 1〜5にしておく
      range: 2-5
      cooldown:
        in: 30s
        out: 60s
      cpu_percentage: 50

secrets: # 環境変数（secret managerに保存済み）
  NODE_OPTIONS: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NODE_OPTIONS
  NEXT_PUBLIC_ORIGIN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_ORIGIN
  NEXT_PUBLIC_SERVICE_ORIGIN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_SERVICE_ORIGIN
  RUN_MODE: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/RUN_MODE
  NEXTAUTH_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXTAUTH_URL
  NEXTAUTH_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXTAUTH_SECRET
  SQUARE_WEBHOOK_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_WEBHOOK_URL
  SQUARE_OAUTH_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_URL
  RUN_SQUARE: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/RUN_SQUARE
  SQUARE_WEBHOOK_SIGNATURE_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_WEBHOOK_SIGNATURE_KEY
  SQUARE_OAUTH_REDIRECT_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_REDIRECT_URL
  SQUARE_OAUTH_APPLICATION_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_APPLICATION_ID
  SQUARE_OAUTH_APPLICATION_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_OAUTH_APPLICATION_SECRET
  SQUARE_RUN_MODE: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_RUN_MODE
  SQUARE_REFID_PREFIX: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SQUARE_REFID_PREFIX
  DATABASE_SERVER_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/DATABASE_SERVER_URL
  NEXT_PUBLIC_DATABASE_KIND: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_DATABASE_KIND
  READREP_DATABASE_SERVER_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/READREP_DATABASE_SERVER_URL

  ELASTI_CACHE_ENDPOINT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/ELASTI_CACHE_ENDPOINT
  SYSTEM_EMAIL_ADDRESS: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SYSTEM_EMAIL_ADDRESS
  SERVICE_EMAIL_ADDRESS: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SERVICE_EMAIL_ADDRESS
  PYTHON_API_ENDPOINT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PYTHON_API_ENDPOINT
  NEXT_PUBLIC_EC_ORIGIN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXT_PUBLIC_EC_ORIGIN
  MYCA_ADMIN_TOKEN: /copilot/app-main-api/production/secrets/ADMIN_PASSWORD
  MASTER_PASSWORD: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/MASTER_PASSWORD
  GMO_OPENAPI_BASE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_BASE_URL
  GMO_OPENAPI_USERNAME: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_USERNAME
  GMO_OPENAPI_PASSWORD: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_PASSWORD
  GMO_OPENAPI_USERNAME_CONTRACT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_USERNAME_CONTRACT
  GMO_OPENAPI_PASSWORD_CONTRACT: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_OPENAPI_PASSWORD_CONTRACT
  ITEM_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/ITEM_WORKER_QUEUE_URL
  ITEM_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/ITEM_SNS_TOPIC_ARN
  SLACK_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SLACK_SNS_TOPIC_ARN
  SLACK_INFRA_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SLACK_INFRA_SNS_TOPIC_ARN
  TRANSACTION_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/TRANSACTION_WORKER_QUEUE_URL
  TRANSACTION_SNS_TOPIC_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/TRANSACTION_SNS_TOPIC_ARN
  EVENT_BRIDGE_SQS_ROLE_ARN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/EVENT_BRIDGE_SQS_ROLE_ARN
  BOT_TOKEN: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/BOT_TOKEN
  EC_ORDER_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/EC_ORDER_WORKER_QUEUE_URL
  EXTERNAL_EC_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/EXTERNAL_EC_WORKER_QUEUE_URL
  GMO_WEBHOOK_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GMO_WEBHOOK_URL
  PRODUCT_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRODUCT_WORKER_QUEUE_URL
  SCHEDULED_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SCHEDULED_WORKER_QUEUE_URL
  NOTIFICATION_WORKER_QUEUE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NOTIFICATION_WORKER_QUEUE_URL
  AMAZON_ACCESS_KEY_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/AMAZON_ACCESS_KEY_ID
  AMAZON_SECRET_ACCESS_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/AMAZON_SECRET_ACCESS_KEY
  AMAZON_S3_BUCKET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/AMAZON_S3_BUCKET
  BARCODE_PRIVATE_KEY: /copilot/app-main-api/production/secrets/BARCODE_PRIVATE_KEY
  BARCODE_IV: /copilot/app-main-api/production/secrets/BARCODE_IV
  PRIVATE_STATIC_BUCKET_PRIVATE_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_PRIVATE_KEY
  PRIVATE_STATIC_BUCKET_KEY_PAIR_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_KEY_PAIR_ID
  PRIVATE_STATIC_BUCKET_CLOUDFRONT_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_CLOUDFRONT_URL
  PRIVATE_STATIC_BUCKET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET
  PRIVATE_STATIC_BUCKET_HOST: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/PRIVATE_STATIC_BUCKET_HOST
  SHOPIFY_APP_CLIENT_ID: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SHOPIFY_APP_CLIENT_ID
  SHOPIFY_APP_CLIENT_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SHOPIFY_APP_CLIENT_SECRET
  SHOPIFY_OAUTH_CALLBACK_URI: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/SHOPIFY_OAUTH_CALLBACK_URI
  MYCA_APP_JWT_PUBLIC_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/MYCA_APP_JWT_PUBLIC_KEY
