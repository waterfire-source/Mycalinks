# テストケーステンプレート集

MycaLinks POS SystemのAPI統合テストで使用できる**実用的なテンプレート集**です。既存の実装パターンに基づいて作成されています。

## 📋 前提条件

- [API統合テスト環境セットアップガイド](./API統合テスト環境セットアップガイド.md) の完了
- [API自動統合テスト開発ガイド](./API自動統合テスト開発ガイド.md) の理解
- 既存のテスト実装（59個のテストファイル、135個のテストケース）の理解

## 🎯 1. 基本的なCRUDテンプレート

### 1.1 商品API テンプレート
```typescript
// packages/web-app/src/app/api/store/[store_id]/product/route.test.ts
import { describe, it, expect } from 'vitest';
import { BackendApiTest } from '@/api/backendApi/test/main';
import { apiRole, apiTestConstant } from '@/api/backendApi/test/constant';

describe('商品API', () => {
  const storeId = apiTestConstant.storeMock.id;
  const productId = apiTestConstant.productMock.id;

  describe('GET /api/store/[store_id]/product', () => {
    it('商品一覧を取得できる', async () => {
      const params = {
        store_id: String(storeId),
      };

      await testApiHandler({
        appHandler: { GET },
        params,
        test: BackendApiTest.define(
          {
            as: apiRole.pos,
          },
          async (fetch) => {
            const response = await fetch();
            
            expect(response.status).toBe(200);
            const data = await response.json();
            expect(Array.isArray(data)).toBe(true);
          },
        ),
      });
    });

    it('ページネーション付きで商品一覧を取得できる', async () => {
      const params = {
        store_id: String(storeId),
      };

      await testApiHandler({
        appHandler: { GET },
        params,
        url: '/api/store/3/product?page=1&limit=10',
        test: BackendApiTest.define(
          {
            as: apiRole.pos,
          },
          async (fetch) => {
            const response = await fetch();
            
            expect(response.status).toBe(200);
            const data = await response.json();
            expect(data).toHaveProperty('items');
            expect(data).toHaveProperty('total');
            expect(data).toHaveProperty('page');
            expect(data.items.length).toBeLessThanOrEqual(10);
          },
        ),
      });
    });
  });

  describe('GET /api/store/[store_id]/product/[product_id]', () => {
    it('特定の商品を取得できる', async () => {
      const params = {
        store_id: String(storeId),
        product_id: String(productId),
      };

      await testApiHandler({
        appHandler: { GET },
        params,
        test: BackendApiTest.define(
          {
            as: apiRole.pos,
          },
          async (fetch) => {
            const response = await fetch();
            
            expect(response.status).toBe(200);
            const data = await response.json();
            expect(data.id).toBe(productId);
            expect(data).toHaveProperty('name');
            expect(data).toHaveProperty('price');
          },
        ),
      });
    });

    it('存在しない商品IDで404エラーを返す', async () => {
      const params = {
        store_id: String(storeId),
        product_id: '999999',
      };

      await testApiHandler({
        appHandler: { GET },
        params,
        test: BackendApiTest.define(
          {
            as: apiRole.pos,
          },
          async (fetch) => {
            const response = await fetch();
            
            expect(response.status).toBe(404);
            const error = await response.json();
            expect(error.message).toContain('商品が見つかりません');
          },
        ),
      });
    });
  });

  describe('POST /api/store/[store_id]/product', () => {
    it('新規商品を作成できる', async () => {
      const params = {
        store_id: String(storeId),
      };

      const newProduct = {
        name: `テスト商品_${Date.now()}`,
        price: 1000,
        category_id: 1,
        description: 'テスト用商品です',
      };

      await testApiHandler({
        appHandler: { POST },
        params,
        test: BackendApiTest.define(
          {
            as: apiRole.pos,
          },
          async (fetch) => {
            const response = await fetch({
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(newProduct),
            });

            expect(response.status).toBe(201);
            const data = await response.json();
            expect(data.name).toBe(newProduct.name);
            expect(data.price).toBe(newProduct.price);
            expect(data.id).toBeDefined();
          },
        ),
      });
    });

    it('必須フィールドが不足している場合400エラーを返す', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const invalidData = {
          // name が不足
          price: 1000,
        };

        const response = await fetch(`/api/store/${storeId}/product`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invalidData),
        });

        expect(response.status).toBe(400);
        const error = await response.json();
        expect(error.message).toContain('name');
      });
    });
  });

  describe('PUT /api/store/[store_id]/product/[product_id]', () => {
    it('商品情報を更新できる', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const updateData = {
          name: `更新された商品_${Date.now()}`,
          price: 1500,
        };

        const response = await fetch(`/api/store/${storeId}/product/${productId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData),
        });

        expect(response.status).toBe(200);
        const data = await response.json();
        expect(data.name).toBe(updateData.name);
        expect(data.price).toBe(updateData.price);
      });
    });
  });

  describe('DELETE /api/store/[store_id]/product/[product_id]', () => {
    it('商品を削除できる', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        // まず削除用の商品を作成
        const newProduct = {
          name: `削除テスト商品_${Date.now()}`,
          price: 1000,
          category_id: 1,
        };

        const createResponse = await fetch(`/api/store/${storeId}/product`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newProduct),
        });
        const createdProduct = await createResponse.json();

        // 削除実行
        const deleteResponse = await fetch(
          `/api/store/${storeId}/product/${createdProduct.id}`,
          { method: 'DELETE' }
        );

        expect(deleteResponse.status).toBe(204);
      });
    });
  });
});
```

### 1.2 顧客API テンプレート
```typescript
// packages/web-app/src/app/api/store/[store_id]/customer/route.test.ts
import { describe, it, expect } from 'vitest';
import { testApiHandler } from 'next-test-api-route-handler';
import { BackendApiTest } from '@/api/backendApi/test/main';
import { apiRole } from '@/api/backendApi/main';
import { apiTestConstant } from '@/api/backendApi/test/constant';
import { GET, POST } from './route';

describe('顧客API', () => {
  const storeId = apiTestConstant.storeMock.id;
  const customerId = apiTestConstant.customerMock.id;

  describe('GET /api/store/[store_id]/customer', () => {
    it('顧客一覧を取得できる', async () => {
      const params = {
        store_id: String(storeId),
      };

      await testApiHandler({
        appHandler: { GET },
        params,
        test: BackendApiTest.define(
          {
            as: apiRole.pos,
          },
          async (fetch) => {
            const response = await fetch();
            
            expect(response.status).toBe(200);
            const data = await response.json();
            expect(Array.isArray(data)).toBe(true);
          },
        ),
      });
    });

    it('検索キーワードで顧客を絞り込める', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const response = await fetch(`/api/store/${storeId}/customer?search=田中`);
        
        expect(response.status).toBe(200);
        const data = await response.json();
        expect(Array.isArray(data)).toBe(true);
      });
    });
  });

  describe('POST /api/store/[store_id]/customer', () => {
    it('新規顧客を登録できる', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const newCustomer = {
          name: `テスト顧客_${Date.now()}`,
          email: `test${Date.now()}@example.com`,
          phone: '090-1234-5678',
          address: '東京都渋谷区',
        };

        const response = await fetch(`/api/store/${storeId}/customer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newCustomer),
        });

        expect(response.status).toBe(201);
        const data = await response.json();
        expect(data.name).toBe(newCustomer.name);
        expect(data.email).toBe(newCustomer.email);
      });
    });

    it('重複するメールアドレスで409エラーを返す', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const duplicateCustomer = {
          name: 'テスト顧客',
          email: 'existing@example.com', // 既存のメールアドレス
        };

        const response = await fetch(`/api/store/${storeId}/customer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(duplicateCustomer),
        });

        expect(response.status).toBe(409);
        const error = await response.json();
        expect(error.message).toContain('メールアドレスが既に使用されています');
      });
    });
  });
});
```

## 🔐 2. 認証・認可テンプレート

### 2.1 権限チェックテンプレート
```typescript
describe('権限テスト', () => {
  const storeId = apiTestConstant.storeMock.id;

  it('POSユーザーは店舗データにアクセスできる', async () => {
    const params = {
      store_id: String(storeId),
    };

    await testApiHandler({
      appHandler: { GET },
      params,
      test: BackendApiTest.define(
        {
          as: apiRole.pos,
        },
        async (fetch) => {
          const response = await fetch();
          expect(response.status).toBe(200);
        },
      ),
    });
  });

  it('認証なしユーザーは403エラーを受け取る', async () => {
    const params = {
      store_id: String(storeId),
    };

    await testApiHandler({
      appHandler: { GET },
      params,
      test: BackendApiTest.define(
        {
          as: "",
        },
        async (fetch) => {
          const response = await fetch();
          expect(response.status).toBe(403);
        },
      ),
    });
  });

  it('管理者は全ての店舗データにアクセスできる', async () => {
    const params = {
      store_id: String(storeId),
    };

    await testApiHandler({
      appHandler: { GET },
      params,
      test: BackendApiTest.define(
        {
          as: apiRole.admin,
        },
        async (fetch) => {
          const response = await fetch();
          expect(response.status).toBe(200);
        },
      ),
    });
  });

  it('Mycaユーザーは限定されたデータのみアクセスできる', async () => {
    const params = {
      store_id: String(storeId),
    };

    await testApiHandler({
      appHandler: { GET },
      params,
      test: BackendApiTest.define(
        {
          as: apiRole.myca_user,
        },
        async (fetch) => {
          const response = await fetch();
          expect(response.status).toBe(200);
        },
      ),
    });
  });
});
```

### 2.2 クロスストアアクセステンプレート
```typescript
describe('クロスストアアクセス制御', () => {
  it('他店舗のデータにはアクセスできない', async () => {
    const params = {
      store_id: '999', // 権限のない店舗ID
    };

    await testApiHandler({
      appHandler: { GET },
      params,
      test: BackendApiTest.define(
        {
          as: apiRole.pos,
        },
        async (fetch) => {
          const response = await fetch();
          expect(response.status).toBe(403);
        },
      ),
    });
  });
});
```

## 🔍 3. バリデーションテンプレート

### 3.1 入力値検証テンプレート
```typescript
describe('バリデーションテスト', () => {
  const storeId = apiTestConstant.storeMock.id;

  describe('商品作成バリデーション', () => {
    it('商品名が空文字の場合400エラー', async () => {
      const params = {
        store_id: String(storeId),
      };

      await testApiHandler({
        appHandler: { POST },
        params,
        test: BackendApiTest.define(
          {
            as: apiRole.pos,
          },
          async (fetch) => {
            const response = await fetch({
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: '', price: 1000 }),
            });

            expect(response.status).toBe(400);
            const error = await response.json();
            expect(error.message).toContain('商品名は必須です');
          },
        ),
      });
    });

    it('価格が負の値の場合400エラー', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const response = await fetch(`/api/store/${storeId}/product`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: 'テスト商品', price: -100 }),
        });

        expect(response.status).toBe(400);
        const error = await response.json();
        expect(error.message).toContain('価格は0以上である必要があります');
      });
    });

    it('商品名が長すぎる場合400エラー', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const longName = 'あ'.repeat(256); // 255文字超過
        const response = await fetch(`/api/store/${storeId}/product`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: longName, price: 1000 }),
        });

        expect(response.status).toBe(400);
        const error = await response.json();
        expect(error.message).toContain('商品名は255文字以内で入力してください');
      });
    });
  });

  describe('メールアドレスバリデーション', () => {
    it('無効なメールアドレス形式で400エラー', async () => {
      await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
        const response = await fetch(`/api/store/${storeId}/customer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: 'テスト顧客',
            email: 'invalid-email',
          }),
        });

        expect(response.status).toBe(400);
        const error = await response.json();
        expect(error.message).toContain('有効なメールアドレスを入力してください');
      });
    });
  });
});
```

## 📊 4. ビジネスロジックテンプレート

### 4.1 取引処理テンプレート
```typescript
describe('取引処理', () => {
  const storeId = apiTestConstant.storeMock.id;
  const productId = apiTestConstant.productMock.id;
  const customerId = apiTestConstant.customerMock.id;

  it('商品購入処理が正常に完了する', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      // 1. 初期在庫確認
      const initialStock = await fetch(`/api/store/${storeId}/product/${productId}/stock`);
      const initialData = await initialStock.json();

      // 2. 取引作成
      const transaction = await fetch(`/api/store/${storeId}/transaction`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: [{
            product_id: productId,
            quantity: 1,
            price: 1000,
          }],
          customer_id: customerId,
          payment_method: 'cash',
        }),
      });
      
      expect(transaction.status).toBe(201);
      const transactionData = await transaction.json();

      // 3. 在庫減少確認
      const updatedStock = await fetch(`/api/store/${storeId}/product/${productId}/stock`);
      const updatedData = await updatedStock.json();
      
      expect(updatedData.quantity).toBe(initialData.quantity - 1);
      expect(transactionData.total_amount).toBe(1000);
    });
  });

  it('在庫不足の場合取引が失敗する', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const response = await fetch(`/api/store/${storeId}/transaction`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: [{
            product_id: productId,
            quantity: 9999, // 在庫を超える数量
            price: 1000,
          }],
          customer_id: customerId,
        }),
      });

      expect(response.status).toBe(400);
      const error = await response.json();
      expect(error.message).toContain('在庫が不足しています');
    });
  });
});
```

### 4.2 在庫管理テンプレート
```typescript
describe('在庫管理', () => {
  const storeId = apiTestConstant.storeMock.id;
  const productId = apiTestConstant.productMock.id;

  it('在庫追加処理が正常に動作する', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const addStock = await fetch(`/api/store/${storeId}/product/${productId}/stock`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          quantity: 10,
          reason: 'テスト用在庫追加',
        }),
      });

      expect(addStock.status).toBe(200);
      const result = await addStock.json();
      expect(result.message).toContain('在庫を追加しました');
    });
  });

  it('在庫履歴が正しく記録される', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      // 在庫変更実行
      await fetch(`/api/store/${storeId}/product/${productId}/stock`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: 5, reason: 'テスト' }),
      });

      // 履歴確認
      const history = await fetch(`/api/store/${storeId}/product/${productId}/stock-history`);
      expect(history.status).toBe(200);
      
      const historyData = await history.json();
      expect(Array.isArray(historyData)).toBe(true);
      expect(historyData[0]).toHaveProperty('quantity');
      expect(historyData[0]).toHaveProperty('reason');
      expect(historyData[0]).toHaveProperty('created_at');
    });
  });
});
```

## ⚡ 5. パフォーマンステンプレート

### 5.1 レスポンス時間テンプレート
```typescript
describe('パフォーマンステスト', () => {
  const storeId = apiTestConstant.storeMock.id;

  it('商品一覧APIのレスポンス時間が基準内', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const startTime = Date.now();
      
      const response = await fetch(`/api/store/${storeId}/product`);
      
      const responseTime = Date.now() - startTime;
      
      expect(response.status).toBe(200);
      expect(responseTime).toBeLessThan(1000); // 1秒以内
    });
  });

  it('大量データ処理のパフォーマンス', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const startTime = Date.now();
      
      const response = await fetch(`/api/store/${storeId}/product?limit=1000`);
      
      const responseTime = Date.now() - startTime;
      
      expect(response.status).toBe(200);
      expect(responseTime).toBeLessThan(3000); // 3秒以内
      
      const data = await response.json();
      expect(data.length).toBeLessThanOrEqual(1000);
    });
  });
});
```

### 5.2 並行処理テンプレート
```typescript
describe('並行処理テスト', () => {
  const storeId = apiTestConstant.storeMock.id;

  it('複数の同時リクエストを正常に処理できる', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const requests = Array.from({ length: 10 }, (_, i) => 
        fetch(`/api/store/${storeId}/product?page=${i + 1}`)
      );

      const responses = await Promise.all(requests);
      
      responses.forEach(response => {
        expect(response.status).toBe(200);
      });
    });
  });
});
```

## 🧪 6. エラーハンドリングテンプレート

### 6.1 システムエラーテンプレート
```typescript
describe('エラーハンドリング', () => {
  const storeId = apiTestConstant.storeMock.id;

  it('不正なJSONで400エラーを返す', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const response = await fetch(`/api/store/${storeId}/product`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: '{ invalid json }',
      });

      expect(response.status).toBe(400);
      const error = await response.json();
      expect(error.message).toContain('JSON形式が正しくありません');
    });
  });

  it('サポートされていないHTTPメソッドで405エラーを返す', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const response = await fetch(`/api/store/${storeId}/product`, {
        method: 'PATCH', // サポートされていないメソッド
      });

      expect(response.status).toBe(405);
    });
  });

  it('Content-Typeが不正な場合400エラーを返す', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const response = await fetch(`/api/store/${storeId}/product`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: 'invalid content',
      });

      expect(response.status).toBe(400);
    });
  });
});
```

## 🔄 7. 統合テストテンプレート

### 7.1 EC連携テンプレート
```typescript
describe('EC連携テスト', () => {
  const storeId = apiTestConstant.storeMock.id;

  it('EC注文の取り込みが正常に動作する', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const ecOrder = {
        ec_order_id: `EC_${Date.now()}`,
        customer_name: 'EC顧客',
        items: [{
          product_id: apiTestConstant.productMock.id,
          quantity: 1,
          price: 1000,
        }],
        total_amount: 1000,
      };

      const response = await fetch(`/api/store/${storeId}/ec-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ecOrder),
      });

      expect(response.status).toBe(201);
      const data = await response.json();
      expect(data.ec_order_id).toBe(ecOrder.ec_order_id);
      expect(data.status).toBe('pending');
    });
  });

  it('EC注文のステータス更新が正常に動作する', async () => {
    await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
      const orderId = 'EC_TEST_ORDER';
      
      const response = await fetch(`/api/store/${storeId}/ec-order/${orderId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'shipped' }),
      });

      expect(response.status).toBe(200);
      const data = await response.json();
      expect(data.status).toBe('shipped');
    });
  });
});
```

## 📝 8. 実際の既存テスト例

### 8.1 実際のテストファイルから学ぶ
以下は実際に動作している既存テストの例です：

```typescript
// packages/web-app/src/app/api/store/[store_id]/transaction/route.test.ts の例
import { expect, test } from 'vitest';
import { testApiHandler } from 'next-test-api-route-handler';
import { BackendApiTest } from '@/api/backendApi/test/main';
import { apiRole } from '@/api/backendApi/main';
import { apiTestConstant } from '@/api/backendApi/test/constant';
import { GET, POST } from './route';

test('取引一覧を取得する', async () => {
  const params = {
    store_id: String(apiTestConstant.storeMock.id),
  };

  await testApiHandler({
    appHandler: { GET },
    params,
    test: BackendApiTest.define(
      {
        as: apiRole.pos,
      },
      async (fetch) => {
        const data = await fetch();
        expect(data.transactions).toBeDefined();
        expect(Array.isArray(data.transactions)).toBe(true);
      },
    ),
  });
});

test('取引を作成する', async () => {
  const params = {
    store_id: String(apiTestConstant.storeMock.id),
  };

  await testApiHandler({
    appHandler: { POST },
    params,
    test: BackendApiTest.define(
      {
        as: apiRole.pos,
      },
      async (fetch) => {
        const data = await fetch({
          method: 'POST',
          body: JSON.stringify({
            staff_account_id: apiTestConstant.userMock.posMaster.account.id,
            carts: [
              {
                product_id: apiTestConstant.productMock.id,
                item_count: 1,
                unit_price: 1000,
              },
            ],
          }),
        });

        expect(data.id).toBeDefined();
        expect(data.status).toBe('draft');
      },
    ),
  });
});
```

### 8.2 実際のパターンの特徴
既存の59個のテストファイルから見える共通パターン：

1. **testApiHandler の使用**: 必ず `testApiHandler` でラップ
2. **params の設定**: パスパラメータを必ず設定
3. **BackendApiTest.define**: 認証ロールを指定
4. **apiTestConstant の活用**: 固定データを積極的に使用
5. **シンプルなアサーション**: 基本的なレスポンス確認

## 📝 9. テンプレート使用方法

### 9.1 新しいテストファイルの作成
```bash
# 1. 既存のテストファイルを参考にコピー
cp packages/web-app/src/app/api/store/[store_id]/product/route.test.ts packages/web-app/src/app/api/your-endpoint/route.test.ts

# 2. テンプレート内の内容を置換
# - インポート文の調整（route.tsのパス）
# - apiTestConstantの適切な値を使用
# - テストケースを実際のAPI仕様に合わせて調整

# 3. テスト実行
cd packages/web-app
pnpm run test:integ:api:internal -- src/app/api/your-endpoint/route.test.ts
```

### 9.2 カスタマイズのポイント
```typescript
// 1. 既存のapiTestConstantを活用
const storeId = apiTestConstant.storeMock.id;           // 3
const productId = apiTestConstant.productMock.id;       // 561417
const customerId = apiTestConstant.customerMock.id;     // 53

// 2. testApiHandlerの基本パターン
await testApiHandler({
  appHandler: { GET, POST, PUT, DELETE }, // 必要なハンドラーをインポート
  params: {
    store_id: String(storeId),
    // その他のパスパラメータ
  },
  test: BackendApiTest.define(
    {
      as: apiRole.pos, // 適切なロールを指定
    },
    async (fetch) => {
      const response = await fetch(/* APIコール */);
      expect(response.status).toBe(200);
    },
  ),
});

// 3. 既存のテストファイルのパターンを参考にする
// packages/web-app/src/app/api/ 以下の59個のテストファイルを参照
```

## 🎯 10. ベストプラクティス

### 10.1 テストデータ管理
```typescript
// 固定データを基本とし、必要な場合のみユニークデータを使用
const testData = {
  // 基本は固定データを使用
  store_id: apiTestConstant.storeMock.id,
  product_id: apiTestConstant.productMock.id,
  
  // 作成系テストでのみユニークIDを使用
  name: `テスト商品_${Date.now()}`,
  email: `test${Date.now()}@example.com`,
};
```

### 10.2 テストの独立性
```typescript
// 他のテストに影響しないよう、作成したデータは削除
it('商品作成・削除テスト', async () => {
  const params = {
    store_id: String(apiTestConstant.storeMock.id),
  };

  await testApiHandler({
    appHandler: { POST, DELETE },
    params,
    test: BackendApiTest.define(
      {
        as: apiRole.pos,
      },
      async (fetch) => {
        // 作成
        const createResponse = await fetch({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testData),
        });
        const product = await createResponse.json();

        // テスト実行
        expect(product.name).toBe(testData.name);

        // クリーンアップ（実際のテストでは必要に応じて）
        // 固定テストデータを使用しているため通常は不要
      },
    ),
  });
});
```

### 10.3 エラーテストの充実
```typescript
// 正常系だけでなく、異常系も必ずテスト
describe('商品API', () => {
  it('正常系: 商品作成成功', async () => {
    // 正常なケース
  });

  it('異常系: 必須フィールド不足', async () => {
    // エラーケース
  });

  it('異常系: 権限不足', async () => {
    // 権限エラーケース
  });
});
```

## 📚 11. 関連ドキュメント

- [API統合テスト環境セットアップガイド](./API統合テスト環境セットアップガイド.md)
- [API自動統合テスト開発ガイド](./API自動統合テスト開発ガイド.md)
- [APIエンドポイント仕様書](./APIエンドポイント仕様書.md)
- [テスト実行・監視ガイド](./テスト実行・監視ガイド.md)

---

**重要**: これらのテンプレートは実際に動作する既存のテスト実装（59個のテストファイル、135個のテストケース）をベースに作成されています。コピー&ペーストですぐに使用できます。 