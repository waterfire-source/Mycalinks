# テスト実行・監視ガイド

MycaLinks POS SystemのAPI統合テストを効率的に実行し、継続的に監視するための実践ガイドです。

## 📋 前提条件

- [API統合テスト環境セットアップガイド](./API統合テスト環境セットアップガイド.md) の完了
- 開発サーバーが起動中（`pnpm run dev`）

## 🚀 1. 基本的なテスト実行

### 1.1 全テスト実行
```bash
cd packages/web-app
pnpm run test:integ:api:internal
```

**実行結果例**:
```
✓ packages/web-app/src/app/api/store/[store_id]/product/route.test.ts (8)
✓ packages/web-app/src/app/api/store/[store_id]/customer/route.test.ts (5)
✓ packages/web-app/src/app/api/corporation/route.test.ts (3)

Test Files  59 passed (59)
Tests  135 passed (135)
Start at 14:30:15
Duration 45.2s
```

### 1.2 個別テスト実行
```bash
# 特定のテストファイルのみ
pnpm run test:integ:api:internal -- src/app/api/store/[store_id]/product/route.test.ts

# 特定のテストケースのみ
pnpm run test:integ:api:internal -- --grep "商品一覧"

# 特定のディレクトリのみ
pnpm run test:integ:api:internal -- src/app/api/store/[store_id]/
```

### 1.3 ウォッチモード
```bash
# ファイル変更時に自動実行
pnpm run test:integ:api:internal -- --watch

# 特定のファイルをウォッチ
pnpm run test:integ:api:internal -- --watch src/app/api/store/[store_id]/product/route.test.ts
```

## 📊 2. テスト結果の詳細分析

### 2.1 詳細レポート出力
```bash
# 詳細なレポート表示
pnpm run test:integ:api:internal -- --reporter=verbose

# JSON形式でレポート出力
pnpm run test:integ:api:internal -- --reporter=json > test-results.json

# JUnit形式でレポート出力（CI/CD用）
pnpm run test:integ:api:internal -- --reporter=junit --outputFile=test-results.xml
```

### 2.2 カバレッジ測定
```bash
# テストカバレッジ測定
pnpm run test:integ:api:internal -- --coverage

# カバレッジレポートをHTMLで出力
pnpm run test:integ:api:internal -- --coverage --coverage.reporter=html
```

### 2.3 パフォーマンス分析
```bash
# 実行時間の詳細表示
pnpm run test:integ:api:internal -- --reporter=verbose --logHeapUsage

# 遅いテストの特定
pnpm run test:integ:api:internal -- --reporter=verbose | grep -E "(slow|[0-9]+ms)"
```

## 🔍 3. テスト結果の監視

### 3.1 テスト状況の確認
```bash
# 現在のテスト状況を確認
find src/app/api -name "*.test.ts" | wc -l  # テストファイル数
find src/app/api -name "*.test.ts" -exec grep -l "it(" {} \; | wc -l  # テストケース数
```

### 3.2 失敗したテストの分析
```bash
# 失敗したテストのみ再実行
pnpm run test:integ:api:internal -- --reporter=verbose --bail

# エラーログの詳細確認
pnpm run test:integ:api:internal -- --reporter=verbose 2>&1 | grep -A 10 "FAIL"
```

### 3.3 テスト実行時間の監視
```typescript
// vitest.config.ts での設定例
export default defineConfig({
  test: {
    // テストタイムアウト設定
    testTimeout: 30000,
    
    // 遅いテストの警告閾値
    slowTestThreshold: 5000,
    
    // 並列実行設定
    maxWorkers: 4,
    minWorkers: 1,
  },
});
```

## 🛠️ 4. 継続的インテグレーション（CI）

### 4.1 GitHub Actions設定例
```yaml
# .github/workflows/api-tests.yml
name: API Integration Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23.9.0'
          
      - name: Install pnpm
        run: npm install -g pnpm
        
      - name: Install dependencies
        run: pnpm install
        
      - name: Build project
        run: pnpm run build
        
      - name: Start development server
        run: |
          cd packages/web-app
          pnpm run dev &
          sleep 30  # サーバー起動待機
        
      - name: Run API Integration Tests
        run: |
          cd packages/web-app
          pnpm run test:integ:api:internal --reporter=junit --outputFile=test-results.xml
        
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: packages/web-app/test-results.xml
```

### 4.2 テスト結果の通知設定
```yaml
# Slack通知の追加例
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#info-myca-error'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

## 📈 5. パフォーマンス監視

### 5.1 実行時間の追跡
```bash
# 実行時間をログファイルに記録
echo "$(date): Starting API tests" >> test-performance.log
time pnpm run test:integ:api:internal >> test-performance.log 2>&1
echo "$(date): API tests completed" >> test-performance.log
```

### 5.2 メモリ使用量の監視
```bash
# メモリ使用量を監視しながらテスト実行
pnpm run test:integ:api:internal -- --logHeapUsage --reporter=verbose
```

### 5.3 API応答時間の監視
```typescript
// テスト内でのレスポンス時間測定例
it('API応答時間が適切である', async () => {
  await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
    const startTime = Date.now();
    
    const response = await fetch('/api/store/3/product');
    
    const responseTime = Date.now() - startTime;
    
    expect(response.status).toBe(200);
    expect(responseTime).toBeLessThan(1000); // 1秒以内
  });
});
```

## 🔧 6. トラブルシューティング

### 6.1 よくある問題と解決策

#### テストが全て失敗する
**症状**: 全てのテストが500エラーで失敗
**原因**: 開発サーバーが起動していない
**解決策**:
```bash
# 開発サーバーの起動確認
cd packages/web-app
pnpm run dev

# ブラウザでアクセス確認
# http://localhost:3020 にアクセスできるか確認
```

#### 特定のテストが不安定
**症状**: 同じテストが成功したり失敗したりする
**原因**: テストデータの競合、タイミング問題
**解決策**:
```bash
# 単体でテスト実行して問題を特定
pnpm run test:integ:api:internal -- --reporter=verbose src/app/api/problem/route.test.ts

# 複数回実行して再現性を確認
for i in {1..10}; do
  echo "Run $i"
  pnpm run test:integ:api:internal -- src/app/api/problem/route.test.ts
done
```

#### メモリ不足エラー
**症状**: JavaScript heap out of memory
**解決策**:
```bash
# Node.jsのメモリ制限を増加
export NODE_OPTIONS="--max-old-space-size=8192"
pnpm run test:integ:api:internal
```

### 6.2 デバッグ手法

#### 詳細ログの有効化
```typescript
// テスト内でのデバッグ出力
it('デバッグ用テスト', async () => {
  await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
    console.log('テスト開始');
    
    const response = await fetch('/api/store/3/product');
    
    console.log('Status:', response.status);
    console.log('Headers:', Object.fromEntries(response.headers.entries()));
    
    if (!response.ok) {
      const errorText = await response.text();
      console.log('Error response:', errorText);
    }
    
    expect(response.status).toBe(200);
  });
});
```

#### ネットワーク問題の確認
```bash
# 開発サーバーへの接続確認
curl -I http://localhost:3020/api/store/3/product

# DNS解決の確認
nslookup localhost
```

## 📊 7. 定期的なメンテナンス

### 7.1 週次メンテナンス
```bash
# 全テストの実行と結果確認
pnpm run test:integ:api:internal --reporter=verbose > weekly-test-report.txt

# 遅いテストの特定
grep -E "[0-9]{4,}ms" weekly-test-report.txt

# 失敗したテストの確認
grep -A 5 "FAIL" weekly-test-report.txt
```

### 7.2 月次レビュー
- テストカバレッジの確認
- 新しいAPIエンドポイントのテスト追加
- 非推奨APIのテスト削除
- パフォーマンス改善の検討

### 7.3 テスト環境のクリーンアップ
```bash
# 不要なテストファイルの確認
find src/app/api -name "*.test.ts" -exec grep -L "describe\|it\|test" {} \;

# 使用されていないテストデータの確認
grep -r "apiTestConstant" src/app/api --include="*.test.ts" | cut -d: -f1 | sort | uniq
```

## 🎯 8. ベストプラクティス

### 8.1 効率的なテスト実行
```bash
# 変更されたファイルに関連するテストのみ実行
git diff --name-only | grep -E "(route\.ts|route\.test\.ts)" | \
  sed 's/route\.ts/route.test.ts/' | \
  xargs pnpm run test:integ:api:internal --

# 優先度の高いテストから実行
pnpm run test:integ:api:internal -- --grep "@critical"
```

### 8.2 テスト結果の共有
```bash
# チーム向けテストレポートの生成
pnpm run test:integ:api:internal -- --reporter=html --outputFile=team-report.html

# 簡潔なサマリーの生成
pnpm run test:integ:api:internal -- --reporter=json | jq '.testResults[] | {file: .name, passed: .assertionResults | map(select(.status == "passed")) | length, failed: .assertionResults | map(select(.status == "failed")) | length}'
```

## 📚 9. 関連ドキュメント

- [API統合テスト環境セットアップガイド](./API統合テスト環境セットアップガイド.md)
- [API自動統合テスト開発ガイド](./API自動統合テスト開発ガイド.md)
- [テストケーステンプレート集](./テストケーステンプレート集.md)
- [APIエンドポイント仕様書](./APIエンドポイント仕様書.md)

## 🔗 10. 有用なコマンド一覧

```bash
# 基本実行
pnpm run test:integ:api:internal

# 詳細実行
pnpm run test:integ:api:internal -- --reporter=verbose

# 個別実行
pnpm run test:integ:api:internal -- src/app/api/store/[store_id]/product/route.test.ts

# ウォッチモード
pnpm run test:integ:api:internal -- --watch

# カバレッジ測定
pnpm run test:integ:api:internal -- --coverage

# パフォーマンス監視
pnpm run test:integ:api:internal -- --logHeapUsage

# 失敗時に停止
pnpm run test:integ:api:internal -- --bail

# 特定パターンのテスト
pnpm run test:integ:api:internal -- --grep "商品"
```

---

**重要**: このガイドは実際の動作環境に基づいて作成されています。複雑なDockerセットアップは不要で、シンプルな開発環境で効率的にテストを実行・監視できます。 