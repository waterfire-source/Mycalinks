# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ç›£è¦–ã‚¬ã‚¤ãƒ‰

MycaLinks POS Systemã®APIçµ±åˆãƒ†ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«å®Ÿè¡Œã—ã€ç¶™ç¶šçš„ã«ç›£è¦–ã™ã‚‹ãŸã‚ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

## ğŸ“‹ å‰ææ¡ä»¶

- [APIçµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](./APIçµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰.md) ã®å®Œäº†
- é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ä¸­ï¼ˆ`pnpm run dev`ï¼‰

## ğŸš€ 1. åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### 1.1 å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
cd packages/web-app
pnpm run test:integ:api:internal
```

**å®Ÿè¡Œçµæœä¾‹**:
```
âœ“ packages/web-app/src/app/api/store/[store_id]/product/route.test.ts (8)
âœ“ packages/web-app/src/app/api/store/[store_id]/customer/route.test.ts (5)
âœ“ packages/web-app/src/app/api/corporation/route.test.ts (3)

Test Files  59 passed (59)
Tests  135 passed (135)
Start at 14:30:15
Duration 45.2s
```

### 1.2 å€‹åˆ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
pnpm run test:integ:api:internal -- src/app/api/store/[store_id]/product/route.test.ts

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ã¿
pnpm run test:integ:api:internal -- --grep "å•†å“ä¸€è¦§"

# ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿
pnpm run test:integ:api:internal -- src/app/api/store/[store_id]/
```

### 1.3 ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
pnpm run test:integ:api:internal -- --watch

# ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¦ã‚©ãƒƒãƒ
pnpm run test:integ:api:internal -- --watch src/app/api/store/[store_id]/product/route.test.ts
```

## ğŸ“Š 2. ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°åˆ†æ

### 2.1 è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
```bash
# è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
pnpm run test:integ:api:internal -- --reporter=verbose

# JSONå½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
pnpm run test:integ:api:internal -- --reporter=json > test-results.json

# JUnitå½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ï¼ˆCI/CDç”¨ï¼‰
pnpm run test:integ:api:internal -- --reporter=junit --outputFile=test-results.xml
```

### 2.2 ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
```bash
# ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
pnpm run test:integ:api:internal -- --coverage

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’HTMLã§å‡ºåŠ›
pnpm run test:integ:api:internal -- --coverage --coverage.reporter=html
```

### 2.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
```bash
# å®Ÿè¡Œæ™‚é–“ã®è©³ç´°è¡¨ç¤º
pnpm run test:integ:api:internal -- --reporter=verbose --logHeapUsage

# é…ã„ãƒ†ã‚¹ãƒˆã®ç‰¹å®š
pnpm run test:integ:api:internal -- --reporter=verbose | grep -E "(slow|[0-9]+ms)"
```

## ğŸ” 3. ãƒ†ã‚¹ãƒˆçµæœã®ç›£è¦–

### 3.1 ãƒ†ã‚¹ãƒˆçŠ¶æ³ã®ç¢ºèª
```bash
# ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆçŠ¶æ³ã‚’ç¢ºèª
find src/app/api -name "*.test.ts" | wc -l  # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°
find src/app/api -name "*.test.ts" -exec grep -l "it(" {} \; | wc -l  # ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°
```

### 3.2 å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®åˆ†æ
```bash
# å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ã¿å†å®Ÿè¡Œ
pnpm run test:integ:api:internal -- --reporter=verbose --bail

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è©³ç´°ç¢ºèª
pnpm run test:integ:api:internal -- --reporter=verbose 2>&1 | grep -A 10 "FAIL"
```

### 3.3 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®ç›£è¦–
```typescript
// vitest.config.ts ã§ã®è¨­å®šä¾‹
export default defineConfig({
  test: {
    // ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    testTimeout: 30000,
    
    // é…ã„ãƒ†ã‚¹ãƒˆã®è­¦å‘Šé–¾å€¤
    slowTestThreshold: 5000,
    
    // ä¸¦åˆ—å®Ÿè¡Œè¨­å®š
    maxWorkers: 4,
    minWorkers: 1,
  },
});
```

## ğŸ› ï¸ 4. ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCIï¼‰

### 4.1 GitHub Actionsè¨­å®šä¾‹
```yaml
# .github/workflows/api-tests.yml
name: API Integration Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  api-tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23.9.0'
          
      - name: Install pnpm
        run: npm install -g pnpm
        
      - name: Install dependencies
        run: pnpm install
        
      - name: Build project
        run: pnpm run build
        
      - name: Start development server
        run: |
          cd packages/web-app
          pnpm run dev &
          sleep 30  # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…æ©Ÿ
        
      - name: Run API Integration Tests
        run: |
          cd packages/web-app
          pnpm run test:integ:api:internal --reporter=junit --outputFile=test-results.xml
        
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: packages/web-app/test-results.xml
```

### 4.2 ãƒ†ã‚¹ãƒˆçµæœã®é€šçŸ¥è¨­å®š
```yaml
# Slacké€šçŸ¥ã®è¿½åŠ ä¾‹
      - name: Notify Slack on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#info-myca-error'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

## ğŸ“ˆ 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

### 5.1 å®Ÿè¡Œæ™‚é–“ã®è¿½è·¡
```bash
# å®Ÿè¡Œæ™‚é–“ã‚’ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²
echo "$(date): Starting API tests" >> test-performance.log
time pnpm run test:integ:api:internal >> test-performance.log 2>&1
echo "$(date): API tests completed" >> test-performance.log
```

### 5.2 ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç›£è¦–
```bash
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ç›£è¦–ã—ãªãŒã‚‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pnpm run test:integ:api:internal -- --logHeapUsage --reporter=verbose
```

### 5.3 APIå¿œç­”æ™‚é–“ã®ç›£è¦–
```typescript
// ãƒ†ã‚¹ãƒˆå†…ã§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®šä¾‹
it('APIå¿œç­”æ™‚é–“ãŒé©åˆ‡ã§ã‚ã‚‹', async () => {
  await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
    const startTime = Date.now();
    
    const response = await fetch('/api/store/3/product');
    
    const responseTime = Date.now() - startTime;
    
    expect(response.status).toBe(200);
    expect(responseTime).toBeLessThan(1000); // 1ç§’ä»¥å†…
  });
});
```

## ğŸ”§ 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 6.1 ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

#### ãƒ†ã‚¹ãƒˆãŒå…¨ã¦å¤±æ•—ã™ã‚‹
**ç—‡çŠ¶**: å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒ500ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—
**åŸå› **: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„
**è§£æ±ºç­–**:
```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ç¢ºèª
cd packages/web-app
pnpm run dev

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
# http://localhost:3020 ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèª
```

#### ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãŒä¸å®‰å®š
**ç—‡çŠ¶**: åŒã˜ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã‚Šå¤±æ•—ã—ãŸã‚Šã™ã‚‹
**åŸå› **: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç«¶åˆã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œ
**è§£æ±ºç­–**:
```bash
# å˜ä½“ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã—ã¦å•é¡Œã‚’ç‰¹å®š
pnpm run test:integ:api:internal -- --reporter=verbose src/app/api/problem/route.test.ts

# è¤‡æ•°å›å®Ÿè¡Œã—ã¦å†ç¾æ€§ã‚’ç¢ºèª
for i in {1..10}; do
  echo "Run $i"
  pnpm run test:integ:api:internal -- src/app/api/problem/route.test.ts
done
```

#### ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶**: JavaScript heap out of memory
**è§£æ±ºç­–**:
```bash
# Node.jsã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’å¢—åŠ 
export NODE_OPTIONS="--max-old-space-size=8192"
pnpm run test:integ:api:internal
```

### 6.2 ãƒ‡ãƒãƒƒã‚°æ‰‹æ³•

#### è©³ç´°ãƒ­ã‚°ã®æœ‰åŠ¹åŒ–
```typescript
// ãƒ†ã‚¹ãƒˆå†…ã§ã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
it('ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ†ã‚¹ãƒˆ', async () => {
  await BackendApiTest.define({ as: apiRole.pos }, async (fetch) => {
    console.log('ãƒ†ã‚¹ãƒˆé–‹å§‹');
    
    const response = await fetch('/api/store/3/product');
    
    console.log('Status:', response.status);
    console.log('Headers:', Object.fromEntries(response.headers.entries()));
    
    if (!response.ok) {
      const errorText = await response.text();
      console.log('Error response:', errorText);
    }
    
    expect(response.status).toBe(200);
  });
});
```

#### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œã®ç¢ºèª
```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šç¢ºèª
curl -I http://localhost:3020/api/store/3/product

# DNSè§£æ±ºã®ç¢ºèª
nslookup localhost
```

## ğŸ“Š 7. å®šæœŸçš„ãªãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### 7.1 é€±æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
```bash
# å…¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¨çµæœç¢ºèª
pnpm run test:integ:api:internal --reporter=verbose > weekly-test-report.txt

# é…ã„ãƒ†ã‚¹ãƒˆã®ç‰¹å®š
grep -E "[0-9]{4,}ms" weekly-test-report.txt

# å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ç¢ºèª
grep -A 5 "FAIL" weekly-test-report.txt
```

### 7.2 æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª
- æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆè¿½åŠ 
- éæ¨å¥¨APIã®ãƒ†ã‚¹ãƒˆå‰Šé™¤
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®æ¤œè¨

### 7.3 ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
```bash
# ä¸è¦ãªãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
find src/app/api -name "*.test.ts" -exec grep -L "describe\|it\|test" {} \;

# ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
grep -r "apiTestConstant" src/app/api --include="*.test.ts" | cut -d: -f1 | sort | uniq
```

## ğŸ¯ 8. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 8.1 åŠ¹ç‡çš„ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```bash
# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
git diff --name-only | grep -E "(route\.ts|route\.test\.ts)" | \
  sed 's/route\.ts/route.test.ts/' | \
  xargs pnpm run test:integ:api:internal --

# å„ªå…ˆåº¦ã®é«˜ã„ãƒ†ã‚¹ãƒˆã‹ã‚‰å®Ÿè¡Œ
pnpm run test:integ:api:internal -- --grep "@critical"
```

### 8.2 ãƒ†ã‚¹ãƒˆçµæœã®å…±æœ‰
```bash
# ãƒãƒ¼ãƒ å‘ã‘ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
pnpm run test:integ:api:internal -- --reporter=html --outputFile=team-report.html

# ç°¡æ½”ãªã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
pnpm run test:integ:api:internal -- --reporter=json | jq '.testResults[] | {file: .name, passed: .assertionResults | map(select(.status == "passed")) | length, failed: .assertionResults | map(select(.status == "failed")) | length}'
```

## ğŸ“š 9. é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [APIçµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](./APIçµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰.md)
- [APIè‡ªå‹•çµ±åˆãƒ†ã‚¹ãƒˆé–‹ç™ºã‚¬ã‚¤ãƒ‰](./APIè‡ªå‹•çµ±åˆãƒ†ã‚¹ãƒˆé–‹ç™ºã‚¬ã‚¤ãƒ‰.md)
- [ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé›†](./ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé›†.md)
- [APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜æ›¸](./APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜æ›¸.md)

## ğŸ”— 10. æœ‰ç”¨ãªã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

```bash
# åŸºæœ¬å®Ÿè¡Œ
pnpm run test:integ:api:internal

# è©³ç´°å®Ÿè¡Œ
pnpm run test:integ:api:internal -- --reporter=verbose

# å€‹åˆ¥å®Ÿè¡Œ
pnpm run test:integ:api:internal -- src/app/api/store/[store_id]/product/route.test.ts

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰
pnpm run test:integ:api:internal -- --watch

# ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
pnpm run test:integ:api:internal -- --coverage

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
pnpm run test:integ:api:internal -- --logHeapUsage

# å¤±æ•—æ™‚ã«åœæ­¢
pnpm run test:integ:api:internal -- --bail

# ç‰¹å®šãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ã‚¹ãƒˆ
pnpm run test:integ:api:internal -- --grep "å•†å“"
```

---

**é‡è¦**: ã“ã®ã‚¬ã‚¤ãƒ‰ã¯å®Ÿéš›ã®å‹•ä½œç’°å¢ƒã«åŸºã¥ã„ã¦ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚è¤‡é›‘ãªDockerã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªé–‹ç™ºç’°å¢ƒã§åŠ¹ç‡çš„ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œãƒ»ç›£è¦–ã§ãã¾ã™ã€‚ 