# 在庫（Stock）モジュール

## 概要
店舗の在庫管理を行うモジュール。商品の在庫状況確認、在庫変更、バンドル商品管理、ラベル印刷など包括的な在庫管理機能を実装。

## ディレクトリ構成
```
stock/
├── bundle/                              # バンドル商品管理
│   ├── components/
│   │   └── EditBundleModal.tsx          # バンドル編集モーダル
│   ├── edit/[bundle_id]/page.tsx        # バンドル編集ページ
│   ├── page.tsx                         # バンドル一覧
│   └── register/page.tsx                # バンドル登録
├── change-history/
│   └── list/page.tsx                    # 在庫変更履歴
├── components/
│   ├── detailModal/                     # 在庫詳細モーダル
│   │   ├── contents/                    # モーダル内容
│   │   │   ├── History.tsx              # 履歴表示
│   │   │   ├── information/             # 商品情報
│   │   │   ├── PurchaseDetail.tsx       # 仕入詳細
│   │   │   └── StockChange/             # 在庫変更
│   │   ├── DetailComponent.tsx          # 詳細コンポーネント
│   │   ├── StockChangeLogModal.tsx      # 変更ログモーダル
│   │   ├── StockDetail.tsx              # 在庫詳細
│   │   └── StockDetailModal.tsx         # 詳細モーダル
│   ├── MobileStockPageContent.tsx       # モバイル版コンテンツ
│   ├── NarrowDownComponent.tsx          # 絞り込み
│   ├── ProductSearch.tsx                # 商品検索
│   ├── StockPageContent.tsx             # デスクトップ版コンテンツ
│   ├── TabComponent.tsx                 # タブコンポーネント
│   └── TableComponent.tsx               # テーブルコンポーネント
└── page.tsx                             # メインページ
```

## 主要機能

### 1. 在庫検索・一覧
- **商品検索**: 商品名、JAN、在庫番号での検索
- **絞り込み**: カテゴリ、ジャンル、価格帯、在庫状況
- **ソート機能**: 登録日、価格、在庫数での並び替え
- **ページネーション**: 大量データの効率的表示

### 2. 在庫管理
- **在庫数変更**: 個別・一括在庫数調整
- **在庫移動**: 店舗間在庫移動
- **在庫廃棄**: 不良在庫の廃棄処理
- **在庫カウント**: 実地棚卸機能

### 3. バンドル商品管理
- **バンドル作成**: 複数商品をセット商品として登録
- **バンドル編集**: 構成商品・価格の変更
- **バンドル解除**: セット商品の個別商品への分解
- **在庫連動**: 構成商品在庫との自動連動

### 4. ラベル印刷
- **値札印刷**: Brother QLプリンター連携
- **管理ラベル**: 在庫番号・バーコード印刷
- **印刷オプション**: 
  - 1枚ずつ印刷
  - 在庫数分印刷
- **一括印刷**: 選択商品の一括ラベル出力

### 5. 在庫履歴管理
- **変更履歴**: 在庫数変更の詳細記録
- **操作ログ**: 誰がいつ何を変更したか
- **レポート生成**: 期間別在庫レポート
- **監査証跡**: コンプライアンス対応

## 技術仕様

### 検索・絞り込み機能
```typescript
// 在庫検索のstate管理
const {
  searchState,
  setSearchState,
  fetchProducts,
  selectedFindOption,
  handleChangeFindOption,
} = useStockSearch(store.id, {
  itemPerPage: 30,
  currentPage: 0,
  isActive: true,
  stockNumberGte: 1,
});
```

### ラベル印刷設定
```typescript
type PrintOption = 'stockQuantity' | 'single';

// 印刷オプション選択
<RadioGroup value={printOption} onChange={handlePrintOptionChange}>
  <FormControlLabel value="single" label="1枚ずつ" />
  <FormControlLabel value="stockQuantity" label="在庫数(入力数)" />
</RadioGroup>
```

### API連携
- `/api/stock/search`: 在庫検索
- `/api/stock/update`: 在庫更新
- `/api/stock/history`: 変更履歴
- `/api/bundle/create`: バンドル作成
- `/api/label/print`: ラベル印刷

## UI/UX設計

### デスクトップ版レイアウト
```
┌─────────────────────────────────────────────┐
│ 在庫一覧        [1枚ずつ●] [在庫数○] [印刷] │
├─────────────────────────────────────────────┤
│ 検索: [____________] カテゴリ:[____▼]       │
│ ジャンル:[____▼] 価格:[____]〜[____]       │
├─────────────────────────────────────────────┤
│ ☐ │画像│商品名      │価格  │在庫│最終更新  │
├─────────────────────────────────────────────┤
│ ☑ │[画] │Nintendo..  │25000│ 3 │2025/06/13│
│ ☐ │[画] │PlayStation.│35000│ 1 │2025/06/12│
│ ☑ │[画] │Xbox Series │30000│ 2 │2025/06/11│
├─────────────────────────────────────────────┤
│ [前へ] [1][2][3]...[10] [次へ]              │
└─────────────────────────────────────────────┘
```

### モバイル版レイアウト
- カード表示による商品一覧
- スワイプ操作での在庫変更
- 検索・絞り込みのアコーディオン表示

### 在庫詳細モーダル
```
┌─────────────────────────────────────────────┐
│ 在庫詳細                              [×]  │
├─────────────────────────────────────────────┤
│ [情報] [履歴] [仕入詳細] [在庫変更]         │
├─────────────────────────────────────────────┤
│ 商品画像: [            ]                   │
│ 商品名: Nintendo Switch 本体               │
│ 在庫番号: S202506130001                    │
│ 現在在庫: 3個                              │
│ 販売価格: ¥25,000                          │
│ 仕入価格: ¥20,000                          │
│ 登録日: 2025-06-13                         │
├─────────────────────────────────────────────┤
│ 在庫変更: [+1] [-1] [直接入力: ___]        │
│                              [保存] [キャンセル] │
└─────────────────────────────────────────────┘
```

## 在庫管理フロー

### 1. 在庫検索・確認
1. 商品検索（名前・JAN・在庫番号）
2. 絞り込み条件設定
3. 検索結果一覧表示
4. 在庫詳細確認

### 2. 在庫調整
1. 対象商品選択
2. 調整理由入力
3. 在庫数変更実行
4. 変更履歴記録

### 3. バンドル管理
1. バンドル商品作成
2. 構成商品選択
3. セット価格設定
4. 在庫連動設定

### 4. ラベル印刷
1. 印刷対象商品選択
2. 印刷オプション選択
3. プレビュー確認
4. 印刷実行

## バンドル商品機能
- **セット商品**: 複数商品を1つのセットとして販売
- **価格設定**: セット特別価格の設定
- **在庫連動**: 構成商品の在庫自動計算
- **分解機能**: バンドルの個別商品への戻し

## パフォーマンス最適化
- **仮想スクロール**: 大量データの効率的表示
- **画像遅延読み込み**: 必要時のみ画像読み込み
- **検索結果キャッシュ**: 検索パフォーマンス向上
- **バックグラウンド同期**: 在庫データの定期同期

## セキュリティ考慮事項
- **在庫変更権限**: ロールベースアクセス制御
- **操作ログ記録**: 全ての在庫変更操作を記録
- **データ整合性**: 在庫数の整合性チェック
- **監査証跡**: コンプライアンス対応ログ

## エラーハンドリング
- **在庫更新失敗**: ロールバック処理
- **印刷エラー**: プリンター接続確認
- **データ不整合**: 整合性チェック・修復
- **ネットワークエラー**: オフライン対応

## レポート機能
- **在庫レポート**: 期間別在庫推移
- **移動履歴**: 在庫変更の詳細記録
- **廃棄レポート**: 廃棄商品の集計
- **棚卸レポート**: 実地棚卸結果

## 関連モジュール
- `/purchase`: 買取・仕入れ処理
- `/sale`: 販売処理
- `/item`: 商品マスタ
- `/transaction`: 取引履歴
- `/label`: ラベル印刷設定