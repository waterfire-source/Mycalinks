# 販売（Sale）モジュール

## 概要
POSシステムの中核となる販売機能を提供するモジュール。バーコードスキャン、商品登録、決済処理、レシート印刷などの店頭販売に必要な機能を実装。

## ディレクトリ構成
```
sale/
├── components/
│   ├── BarcodeScanner.tsx      # バーコードスキャナーコンポーネント
│   ├── DesktopSalePage.tsx     # デスクトップ版販売画面
│   └── MobileSalePage.tsx      # モバイル版販売画面
├── return/
│   └── page.tsx                # 返品処理画面
├── [TransactionID]/
│   └── mobileSaleDraftPage/    # 取引下書きページ（モバイル）
└── page.tsx                    # メインページコンポーネント
```

## 主要機能

### 1. 販売処理
- **商品スキャン**: バーコード/QRコードによる商品登録
- **手動商品検索**: 商品名・JANコードでの検索・追加
- **カート管理**: 商品の追加・削除・数量変更
- **価格調整**: 割引適用、特別価格設定
- **顧客紐付け**: 会員カードスキャン・顧客検索

### 2. 決済機能
- **複数決済方法**: 現金、クレジットカード、電子マネー、ポイント
- **分割決済**: 複数の決済方法の組み合わせ
- **レジ操作**: ドロワー開閉、釣銭計算
- **決済確定**: トランザクション完了処理

### 3. レシート・ラベル印刷
- **レシート印刷**: EPSON TMプリンター連携
- **領収書発行**: 宛名入り領収書印刷
- **ラベル印刷**: Brother QLプリンター連携

### 4. 取引管理
- **下書き保存**: 取引の一時保存・再開
- **取引履歴**: 当日の販売履歴確認
- **返品処理**: 商品返品・返金処理

## 技術仕様

### コンポーネント構成
```typescript
// メインページ（レスポンシブ対応）
<SaleCartProvider>
  <ThemeProvider theme={specialTheme}>
    {isMobile ? <MobileSalePage /> : <DesktopSalePage />}
  </ThemeProvider>
</SaleCartProvider>
```

### バーコードスキャナー
- **ライブラリ**: @zxing/browser
- **対応形式**: 
  - 1次元バーコード（JAN, CODE128等）
  - 2次元バーコード（QRコード）
- **検出クールダウン**: 5秒（連続スキャン防止）

### Context/State管理
- **SaleCartContext**: カート状態管理
  - 商品リスト
  - 合計金額計算
  - 顧客情報
  - 決済情報
- **StoreContext**: 店舗情報
- **AlertContext**: ユーザー通知

### API連携
- `/api/transaction/sale`: 販売取引作成・更新
- `/api/product/search`: 商品検索
- `/api/customer/search`: 顧客検索
- `/api/payment/process`: 決済処理

## UI/UX設計

### デスクトップ版レイアウト
```
┌─────────────────────────────────────────────┐
│ ヘッダー（店舗名・ユーザー情報）              │
├───────────────┬─────────────────────────────┤
│               │ 商品リスト                   │
│ 顧客情報      │ ├─商品1 [数量] [価格]      │
│               │ ├─商品2 [数量] [価格]      │
│ スキャンボタン │ └─商品3 [数量] [価格]      │
│               ├─────────────────────────────┤
│ 取引下書き    │ 小計: ¥10,000               │
│               │ 税額: ¥1,000                │
│               │ 合計: ¥11,000               │
│               ├─────────────────────────────┤
│               │ [決済へ進む]                 │
└───────────────┴─────────────────────────────┘
```

### モバイル版レイアウト
- タブ切り替えによる画面遷移
- スワイプ操作対応
- 縦持ち最適化

## セキュリティ考慮事項
- 決済情報の暗号化
- 操作ログの記録
- 権限に基づく機能制限
- レジ締め時の金額確認

## パフォーマンス最適化
- 商品検索の遅延ローディング
- バーコードスキャンのデバウンス処理
- 大量商品登録時のバッチ処理
- レシート印刷の非同期処理

## エラーハンドリング
- ネットワークエラー時の取引保存
- プリンター接続エラーの通知
- 在庫不足警告
- 決済失敗時のロールバック

## 関連モジュール
- `/purchase`: 買取処理
- `/stock`: 在庫管理
- `/customer`: 顧客管理
- `/transaction`: 取引履歴