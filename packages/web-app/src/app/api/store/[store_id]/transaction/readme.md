# 取引API一覧

## 定義ファイル

/api/store/[store_id]/transaction/api.d.ts

### 取引作成API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/` |
| メソッド | POST |
| 権限 | corp |
| 処理内容 | ・販売/買取の取引レコードを作成しつつ、在庫調整を行うことができる<br>・在庫変動履歴も残す<br>・現金払いだった時は店の現金設定を調整する<br>・ここでSquare APIを叩き、決済処理も終わらせる<br>・asDraft: trueとすることで、下書き作成ができる<br>・idを指定することで、既存の下書きを変更することができる<br>・買い取りモードで、下書きをはじめて作成し、顧客情報をしっかり結びつけている時、自動的に買取受付番号が発行され、その番号が返却される<br>・カート情報でセールIDを指定することで、特定のセールを商品に適用することができる |
| 備考 | 会計処理時にそのセールをその商品に結びつけることができるのか自動で判断され、無効だった場合会計処理がすべてロールバックされる |

### 取引取得API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/` |
| メソッド | GET |
| 権限 | corp または 認証なし |
| 処理内容 | ・条件を指定して、過去の取引の一覧を取得することができる<br>・includeSalesパラメータをつけることで、その条件における売上のまとめを取得することができる |
| 備考 | ・認証なしでも実行できるが、取得できるフィールドが制限される<br>・/api/admin/~みたいな感じで管理用APIとお客さん用APIのエンドポイントを分けるか検討中 |

### 特定取引取得API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/[transaction_id]/` |
| メソッド | GET |
| 権限 | なし |
| 処理内容 | ・特定のIDの取引情報を取得することができる<br>・取得できるフィールドは現在、ステータスや査定状況などのみ |
| 備考 | ・未認証ユーザーでも実行できる<br>・認証済みユーザーは現状、取引詳細情報を取得するのに上のAPIを利用するため、このAPIは使わない想定 |

### 完了済み取引変更API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/[transaction_id]/` |
| メソッド | PUT |
| 権限 | corp |
| 処理内容 | ・もう完了している取引の情報を更新することができる<br>・取引に結びつける顧客のIDを変えることができる |
| 備考 | ・下書き取引を編集するときはPOSTメソッドの方を使う<br>・顧客ID変更時は、ポイントの再付与処理も行われる |

### 返品API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/[transaction_id]/return/` |
| メソッド | POST |
| 権限 | corp |
| 処理内容 | ・既存の取引の返品＆返金処理を行うことができる<br>・バンドル商品だった場合は、結びついている商品の在庫数も変動させる<br>・在庫変動履歴も残す<br>・現金払いだった時は店の現金設定を調整する |
| 備考 | ・ここでSquare APIを叩き、返金処理も行う（ローカルだとSquareは叩かれないようにしている） |

### レシート/領収書用HTML発行API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/[transaction_id]/receipt/` |
| メソッド | GET |
| 権限 | corp |
| 処理内容 | ・クエリパラメータで指定することで、レシートor領収書を発行できる<br>・生のHTMLコードが返ってくるため、それをプリンターに送る想定 |
| 備考 | ・領収書についてはrotateで回転された状態になっているため注意が必要 |

### 取引キャンセルAPI

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/[transaction_id]/cancel/` |
| メソッド | POST |
| 権限 | corp |
| 処理内容 | ・IDを指定することで、既存の取引のキャンセルを行うことができる<br>・なお、現在のところ下書きの取引に限る |
| 備考 | ・販売会計中に、端末に決済をリクエストしていた時（支払い方法がカード・PayPay・電子マネーのいずれか）に限り、会計待機中にこのAPIを使ってキャンセルを行うことができる |

### 取引一覧CSV取得API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/csv/` |
| メソッド | GET |
| 権限 | corp |
| 処理内容 | ・過去のすべての取引をCSVファイル形式で取得することができる |
| 備考 | |

### 見積書用HTML発行API

| 項目 | 値 |
|-----|-----|
| URL | `/api/store/[store_id]/transaction/estimate/` |
| メソッド | GET |
| 権限 | corp |
| 処理内容 | ・カートの中身、合計金額などを入力することが見積書用のHTMLを取得することができる |
| 備考 | ・まだアプリとの連動機能は搭載されていない<br>・今後、下書きの取引IDを使って発行できる様にしたい |